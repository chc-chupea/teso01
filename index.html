<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ‰‹ç›¸AIè¨ºæ–­ - ã‚«ãƒ¡ãƒ©å¯¾å¿œç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #e0f7fa;
      text-align: center;
      padding: 20px;
    }
    canvas {
      border: 1px solid #ccc;
      max-width: 100%;
      touch-action: manipulation;
    }
    button, input[type="file"] {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background: #4dd0e1;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    #resultText {
      margin-top: 10px;
      font-size: 16px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2>ğŸ“· æ‰‹ã®ã²ã‚‰ã§AIæ‰‹ç›¸è¨ºæ–­ï¼ˆã‚«ãƒ¡ãƒ©å¯¾å¿œï¼‰</h2>
  <input type="file" id="fileInput" accept="image/*" capture="environment" />
  <canvas id="canvas"></canvas><br />
  <button id="diagnoseBtn">ğŸ§  è¨ºæ–­ã™ã‚‹</button>
  <div id="resultText"></div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const diagnoseBtn = document.getElementById("diagnoseBtn");
    const resultText = document.getElementById("resultText");

    let lines = [];

    fileInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        setTimeout(() => processImage(img), 500);
      };
      img.src = URL.createObjectURL(file);
    });

    function processImage(img) {
      const src = cv.imread(img);
      let gray = new cv.Mat();
      let edges = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 1.5, 1.5);
      cv.Canny(gray, edges, 50, 150);

      let linesMat = new cv.Mat();
      cv.HoughLinesP(edges, linesMat, 1, Math.PI / 180, 60, 60, 10);

      lines = [];
      for (let i = 0; i < linesMat.rows; i++) {
        let [x1, y1, x2, y2] = linesMat.intPtr(i);
        lines.push({ x1, y1, x2, y2, label: null });
      }

      classifyLinesAI(lines, canvas.height);
      drawLines();

      src.delete();
      gray.delete();
      edges.delete();
      linesMat.delete();
    }

    function classifyLinesAI(lines, height) {
      lines.forEach(line => {
        const angle = lineAngle(line);
        const centerY = (line.y1 + line.y2) / 2;

        // ç°¡æ˜“åˆ¤å®š: ä¸Šéƒ¨ã‚¨ãƒªã‚¢ã‹ã¤å‚¾ããŒä¸‹å‘ããªã‚‰æ„Ÿæƒ…ç·š
        if (centerY < height * 0.33 && angle < -10 && angle > -80) {
          line.label = "æ„Ÿæƒ…ç·š";
        }
        // ä¸­å¤®ã‚¨ãƒªã‚¢ã¯çŸ¥èƒ½ç·š
        else if (centerY >= height * 0.33 && centerY < height * 0.66) {
          line.label = "çŸ¥èƒ½ç·š";
        }
        // ãã‚Œä»¥å¤–ã¯ç”Ÿå‘½ç·š
        else {
          line.label = "ç”Ÿå‘½ç·š";
        }
      });
    }

    function drawLines() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 2;
      lines.forEach(line => {
        switch (line.label) {
          case "æ„Ÿæƒ…ç·š": ctx.strokeStyle = "red"; break;
          case "çŸ¥èƒ½ç·š": ctx.strokeStyle = "blue"; break;
          case "ç”Ÿå‘½ç·š": ctx.strokeStyle = "green"; break;
          default: ctx.strokeStyle = "gray"; break;
        }
        ctx.beginPath();
        ctx.moveTo(line.x1, line.y1);
        ctx.lineTo(line.x2, line.y2);
        ctx.stroke();
      });
    }

    diagnoseBtn.addEventListener("click", () => {
      const diagnosis = generateDiagnosis(lines);
      resultText.innerText = diagnosis.join("\n");
      drawLines();
      ctx.fillStyle = "black";
      ctx.font = "16px sans-serif";
      diagnosis.forEach((text, i) => {
        ctx.fillText(text, 10, canvas.height - (diagnosis.length - i) * 24);
      });
    });

    function lineLength(line) {
      return Math.hypot(line.x2 - line.x1, line.y2 - line.y1);
    }

    function lineAngle(line) {
      return Math.atan2(line.y2 - line.y1, line.x2 - line.x1) * 180 / Math.PI;
    }

    function generateDiagnosis(lines) {
      const result = [];
      const emotionLine = lines.find(l => l.label === "æ„Ÿæƒ…ç·š");
      const brainLine = lines.find(l => l.label === "çŸ¥èƒ½ç·š");
      const lifeLine = lines.find(l => l.label === "ç”Ÿå‘½ç·š");

      if (emotionLine) {
        const len = lineLength(emotionLine);
        const ang = lineAngle(emotionLine);
        if (len > 250 && ang < -20) {
          result.push("ğŸ’– æ‹æ„›ï¼šæƒ…ç†±çš„ã§æ‹ã«ä¸€ç›´ç·šï¼");
        } else if (len > 200 && ang > 0) {
          result.push("ğŸ’– æ‹æ„›ï¼šæ„›æƒ…æ·±ãå°½ãã™ã‚¿ã‚¤ãƒ—");
        } else if (len < 150) {
          result.push("ğŸ’– æ‹æ„›ï¼šæ‹ã«å¥¥æ‰‹ã§ãªã‹ãªã‹å‹•ã‘ãªã„");
        } else {
          result.push("ğŸ’– æ‹æ„›ï¼šæ„Ÿæƒ…ã¯å†…ã«ç§˜ã‚ã‚‹ã‚¿ã‚¤ãƒ—");
        }
      }

      if (brainLine) {
        const ang = lineAngle(brainLine);
        if (ang < -45) {
          result.push("ğŸ§  é ­è„³ï¼šç›´æ„Ÿæ´¾ãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢é‡è¦–ã‚¿ã‚¤ãƒ—");
        } else if (ang > -15) {
          result.push("ğŸ§  é ­è„³ï¼šè«–ç†æ´¾ãƒ»æ…é‡ãªåˆ†æå‹");
        } else {
          result.push("ğŸ§  é ­è„³ï¼šçŠ¶æ³åˆ¤æ–­ãŒå¾—æ„ãªãƒãƒ©ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—");
        }
      }

      if (lifeLine) {
        const len = lineLength(lifeLine);
        if (len > 250) {
          result.push("ğŸ’ª å¥åº·ï¼šä½“åŠ›ãƒ»ç²¾ç¥åŠ›ã¨ã‚‚ã«å¼·é­ï¼");
        } else if (len > 180) {
          result.push("ğŸ’ª å¥åº·ï¼šå¥åº·ã¸ã®æ„è­˜ãŒé«˜ã„ã‚¿ã‚¤ãƒ—");
        } else {
          result.push("ğŸ’ª å¥åº·ï¼šç„¡ç†ã—ã™ããšä¼‘æ¯ã‚‚å¤§åˆ‡ã«");
        }
      }

      if (emotionLine && brainLine) {
        const dy = Math.abs(emotionLine.y1 - brainLine.y1);
        if (dy < 30) {
          result.push("ğŸ’° é‡‘é‹ï¼šè¨ˆç”»çš„ã«è²¯ã‚ã‚‹ã‚¿ã‚¤ãƒ—");
        } else if (dy > 60) {
          result.push("ğŸ’° é‡‘é‹ï¼šãŠé‡‘ã®æµã‚Œã«æ³¢ãŒã‚ã‚Šãã†");
        } else {
          result.push("ğŸ’° é‡‘é‹ï¼šäººè„ˆãŒé‡‘é‹ã‚’å·¦å³ã™ã‚‹ã‚¿ã‚¤ãƒ—");
        }
      } else {
        result.push("ğŸ’° é‡‘é‹ï¼šå …å®Ÿã¨å¤§èƒ†ã®ä¸­é–“ã‚¿ã‚¤ãƒ—");
      }

      if (brainLine) {
        const ang = lineAngle(brainLine);
        const len = lineLength(brainLine);
        if (ang < -45 && len > 200) {
          result.push("ğŸ’¼ ä»•äº‹ï¼šå‰µé€ çš„ãªä»•äº‹ã«ã‚„ã‚ŠãŒã„ã‚’æ„Ÿã˜ã‚‹");
        } else if (ang > -20) {
          result.push("ğŸ’¼ ä»•äº‹ï¼šè«–ç†å‹ã§ITãƒ»ç ”ç©¶ã«å‘ã");
        } else {
          result.push("ğŸ’¼ ä»•äº‹ï¼šç©ºæ°—ã‚’èª­ã‚“ã§å‹•ããƒãƒ©ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—");
        }
      }

      return result;
    }
  </script>
</body>
</html>
