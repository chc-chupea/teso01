<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>手相占いカメラ診断</title>
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Kosugi Maru', sans-serif;
      background-color: #fdf5e6;
      color: #333;
      margin: 0;
      padding: 1em;
      text-align: center;
    }
    h1 {
      font-size: 1.5em;
      color: #7566a0;
      margin-bottom: 0.5em;
    }
    select,
    button {
      font-size: 1em;
      padding: 0.5em 1.2em;
      margin: 1em 0;
      border-radius: 12px;
      border: 1px solid #ccc;
      background-color: #fff;
      cursor: pointer;
      user-select: none;
    }
    #videoElement,
    canvas {
      width: 100%;
      max-width: 400px;
      border-radius: 10px;
      margin: 0.5em 0;
      background: black;
    }
    .result {
      background-color: #fff;
      border-radius: 10px;
      padding: 1em;
      margin-top: 1em;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      white-space: pre-line;
      min-height: 6em;
    }
    .share-btn {
      background-color: #ffe0b2;
      color: #5d4037;
      margin: 0.5em;
      border: none;
      cursor: pointer;
      user-select: none;
    }
    #countdown {
      font-size: 5em;
      font-weight: bold;
      color: #ff5722;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      user-select: none;
      text-shadow: 0 0 8px #ff5722;
      display: none;
      z-index: 100;
    }
    #container {
      position: relative;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h1>スマホ手相占いカメラ診断</h1>
  <p>まずはジャンルを選んでね！（全部診断もOK）</p>
  <select id="genre">
    <option value="">ジャンルを選んでください</option>
    <option value="all">全部自動診断</option>
    <option value="love">恋愛</option>
    <option value="work">仕事</option>
    <option value="money">金運</option>
    <option value="health">健康</option>
    <option value="personality">性格</option>
  </select>
  <br />
  <button id="startButton">カメラ起動</button>
  <button id="shutterButton" style="display:none;">📸 シャッター</button>

  <div id="container">
    <video autoplay playsinline id="videoElement"></video>
    <canvas id="canvas"></canvas>
    <div id="countdown">3</div>
  </div>

  <div class="result" id="result"></div>
  <button class="share-btn" onclick="shareLINE()">LINEでシェア</button>
  <button class="share-btn" onclick="shareInstagram()">インスタDMで送る</button>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://docs.opencv.org/4.6.0/opencv.js"></script>
  <script>
    const video = document.getElementById("videoElement");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const resultBox = document.getElementById("result");
    const startButton = document.getElementById("startButton");
    const shutterButton = document.getElementById("shutterButton");
    const countdownEl = document.getElementById("countdown");

    let handednessResult = "";
    let currentHand = "left";
    let model;
    let camera;
    let isProcessing = false;
    let streamingStarted = false;
    let mediaStream = null;

    const detailedComments = {
      left: {
        personality: Array.from({ length: 20 }, (_, i) => `【性格Lv${i + 1}】繊細で思慮深い一面あり`),
        love: Array.from({ length: 20 }, (_, i) => `【恋愛Lv${i + 1}】理想高めで内に秘めた情熱派`),
        health: Array.from({ length: 20 }, (_, i) => `【健康Lv${i + 1}】自己管理力が光るタイプ`),
        all: Array.from({ length: 20 }, (_, i) => `【全体Lv${i + 1}】内面の魅力がじわじわ伝わる人`),
      },
      right: {
        work: Array.from({ length: 20 }, (_, i) => `【仕事Lv${i + 1}】着実に信頼を積む努力家`),
        money: Array.from({ length: 20 }, (_, i) => `【金運Lv${i + 1}】堅実派でコツコツ型の貯蓄スタイル`),
        health: Array.from({ length: 20 }, (_, i) => `【健康Lv${i + 1}】活発でポジティブ体質`),
        love: Array.from({ length: 20 }, (_, i) => `【恋愛Lv${i + 1}】前向きな恋の立役者`),
        all: Array.from({ length: 20 }, (_, i) => `【全体Lv${i + 1}】今が勝負どき、努力は実を結ぶ`),
      },
    };

    const generateDetailedComment = (score, genre, hand) => {
      const dict = detailedComments[hand][genre] || detailedComments[hand].all;
      const level = Math.max(0, Math.min(19, Math.floor(score)));
      return dict[level] || "分析中…";
    };

    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
    });

    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7,
    });

    hands.onResults(async (results) => {
      if (!isProcessing) return;

      if (results.multiHandedness && results.multiHandedness.length > 0) {
        currentHand = results.multiHandedness[0].label === "Right" ? "right" : "left";
        handednessResult = currentHand === "right" ? "右手（現在・運勢）" : "左手（素質・性格）";
      }

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      const src = cv.imread(canvas);
      const gray = new cv.Mat();
      const edges = new cv.Mat();

      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.Canny(gray, edges, 50, 150);

      let contours = new cv.MatVector();
      let hierarchy = new cv.Mat();
      cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      let totalLength = 0;
      let totalAngle = 0;
      let count = 0;

      for (let i = 0; i < contours.size(); i++) {
        let contour = contours.get(i);
        const length = cv.arcLength(contour, false);
        if (length < 30) {
          contour.delete();
          continue;
        }

        const rotatedRect = cv.minAreaRect(contour);
        let angle = rotatedRect.angle;
        if (angle < -45) angle += 90;

        totalLength += length;
        totalAngle += angle;
        count++;
        contour.delete();
      }

      contours.delete();
      hierarchy.delete();
      gray.delete();
      src.delete();
      edges.delete();

      const avgLength = count > 0 ? totalLength / count : 0;
      const avgAngle = count > 0 ? totalAngle / count : 0;

      const lengthScore = Math.min(1, avgLength / 300);
      const angleScore = (avgAngle + 45) / 90;

      let combinedScore = Math.floor((lengthScore * 0.6 + angleScore * 0.4) * 19);

      let tfImg = tf.browser.fromPixels(canvas);
      tfImg = tf.image.resizeBilinear(tfImg, [64, 64]);
      tfImg = tfImg.expandDims(0).toFloat().div(255);

      let predictionText = "";
      if (model) {
        const prediction = await model.predict(tfImg).data();
        const labels = ["感情線", "頭脳線", "生命線", "運命線"];
        const maxIndex = prediction.indexOf(Math.max(...prediction));
        predictionText = `AI判定：${labels[maxIndex]}が明瞭です`;

        if (labels[maxIndex] === "生命線") {
          combinedScore = Math.min(19, combinedScore + 3);
        }
      }
      tfImg.dispose();

      const genre = document.getElementById("genre").value || "all";
      const comment = generateDetailedComment(combinedScore, genre, currentHand);

      resultBox.innerHTML = `<h2>${handednessResult} 診断</h2>
        <p>${comment}</p>
        <p>${predictionText}</p>
        <p>線の平均長さ: ${avgLength.toFixed(1)} px<br>線の傾き: ${avgAngle.toFixed(1)}°</p>`;

      isProcessing = false;
      shutterButton.disabled = false;
      shutterButton.textContent = "📸 シャッター";
    });

    // 外カメラ優先でdeviceId指定する関数
    async function getBackCameraDeviceId() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
        return null;
      }
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === "videoinput");
      // ラベルに back または rear があるものを探す
      for (const device of videoDevices) {
        if (device.label.toLowerCase().includes("back") || device.label.toLowerCase().includes("rear")) {
          return device.deviceId;
        }
      }
      // 見つからなければ最初のビデオ入力を返す
      return videoDevices.length > 0 ? videoDevices[0].deviceId : null;
    }

    async function startCameraFunc() {
      if (streamingStarted) return;
      try {
        const backCameraId = await getBackCameraDeviceId();
        if (!backCameraId) {
          alert("カメラが見つかりませんでした。");
          return;
        }
        console.log("外カメラデバイスID:", backCameraId);
        if (mediaStream) {
          // 古いストリームがあれば停止
          mediaStream.getTracks().forEach(track => track.stop());
        }
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: backCameraId } },
          audio: false,
        });
        video.srcObject = mediaStream;

        camera = new Camera(video, {
          onFrame: async () => {
            if (!isProcessing) return;
            await hands.send({ image: video });
          },
          width: 640,
          height: 480,
        });
        camera.start();

        model = await tf.loadLayersModel("/model/model.json");

        streamingStarted = true;
        startButton.style.display = "none";
        shutterButton.style.display = "inline-block";
        resultBox.textContent = "カメラ起動完了！手を映してシャッターボタンを押してね。";
      } catch (e) {
        alert("カメラの起動に失敗しました: " + e.message);
      }
    }

    startButton.addEventListener("click", () => {
      startCameraFunc();
    });

    shutterButton.addEventListener("click", () => {
      if (!streamingStarted || isProcessing) return;

      let count = 3;
      countdownEl.textContent = count;
      countdownEl.style.display = "block";
      shutterButton.disabled = true;
      shutterButton.textContent = "撮影中...";

      const countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
          countdownEl.textContent = count;
        } else {
          clearInterval(countdownInterval);
          countdownEl.style.display = "none";

          isProcessing = true;
          resultBox.textContent = "占い中…✨";
          hands.send({ image: video });
        }
      }, 1000);
    });

    function shareLINE() {
      const text = encodeURIComponent("手相占いやってみた！\n診断結果はこちら→ https://your-app-link.com");
      window.open(`https://line.me/R/msg/text/?${text}`, "_blank");
    }

    function shareInstagram() {
      alert("インスタのDMには、診断結果をスクショして送ってね！");
    }
  </script>
</body>
</html>
